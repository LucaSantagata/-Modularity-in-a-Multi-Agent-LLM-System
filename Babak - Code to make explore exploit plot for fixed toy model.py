import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import ast

# --- CONFIGURATION ---
FILE_PATH = "final_static_10trials.csv"

def parse_list(cell):
    """Safely parses string representations of lists from CSV."""
    if isinstance(cell, list):
        return cell
    try:
        return ast.literal_eval(str(cell))
    except:
        return []

def analyze_static_tradeoff(csv_file):
    print(f"Loading {csv_file}...")
    try:
        df = pd.read_csv(csv_file)
    except FileNotFoundError:
        print("‚ùå File not found. Please run the experiment first.")
        return

    # Parse columns
    df['Assigned_Arms'] = df['Assigned_Arms'].apply(parse_list)

    # Storage for results
    summary_data = []
    
    trials = df['Trial_ID'].unique()
    
    # Setup for 10 subplots
    fig, axes = plt.subplots(2, 5, figsize=(20, 10))
    fig.suptitle('Exploration vs. Exploitation (Static Assignments)', fontsize=16)
    axes = axes.flatten()

    for i, trial in enumerate(sorted(trials)):
        # Process specific trial chronologically
        trial_df = df[df['Trial_ID'] == trial].sort_values(by='Round')
        
        # Memory: {agent_id: {arm_id: (average_value, count)}}
        agent_memory = {agent: {} for agent in trial_df['Agent'].unique()}
        
        counts = {'Exploration': 0, 'Exploitation': 0}
        
        for _, row in trial_df.iterrows():
            agent = row['Agent']
            assigned = row['Assigned_Arms']
            chosen = row['Chosen_Arm']
            payoff = row['Payoff']
            
            # 1. Retrieve Subjective Expectations
            known_values = {}
            for arm in assigned:
                if arm in agent_memory[agent]:
                    # Get the average value from the tuple (val, n)
                    known_values[arm] = agent_memory[agent][arm][0]
            
            # 2. Classify Choice
            if not known_values:
                # Forced Exploration (Everything is unknown)
                counts['Exploration'] += 1
            else:
                best_known_val = max(known_values.values())
                
                # Logic:
                # 1. Is the chosen arm actually known? (If not, it's exploration)
                # 2. Is the chosen arm the best one we know of? (If yes, exploitation)
                if (chosen in known_values) and (known_values[chosen] == best_known_val):
                    counts['Exploitation'] += 1
                else:
                    counts['Exploration'] += 1
            
            # 3. Update Memory (Incremental Mean)
            curr_val, curr_n = agent_memory[agent].get(chosen, (0.0, 0))
            new_n = curr_n + 1
            new_val = curr_val + ((payoff - curr_val) / new_n)
            agent_memory[agent][chosen] = (new_val, new_n)

        # Record Trial Data
        summary_data.append({'Trial': trial, 'Type': 'Exploration', 'Count': counts['Exploration']})
        summary_data.append({'Trial': trial, 'Type': 'Exploitation', 'Count': counts['Exploitation']})
        
        # Plot Individual Trial
        if i < 10: # Safety check in case you run more than 10
            ax = axes[i]
            sns.barplot(x=list(counts.keys()), y=list(counts.values()), 
                        palette=['#FF9999', '#66B2FF'], ax=ax)
            ax.set_title(f"Trial {trial}")
            ax.set_ylabel("Count")
            ax.set_ylim(0, max(counts.values()) * 1.15) # Add headroom for text

    plt.tight_layout(rect=[0, 0.03, 1, 0.95])
    plt.show()
    
    # --- BOX PLOT SUMMARY ---
    summary_df = pd.DataFrame(summary_data)
    
    plt.figure(figsize=(8, 6))
    sns.boxplot(x='Type', y='Count', data=summary_df, palette=['#FF9999', '#66B2FF'])
    plt.title("Aggregated Tradeoff: Static Assignments (10 Trials)")
    plt.ylabel("Total Decisions per Trial")
    plt.grid(True, axis='y', alpha=0.3)
    plt.show()
    
    # Print Stats
    avg_explore = summary_df[summary_df['Type']=='Exploration']['Count'].mean()
    avg_exploit = summary_df[summary_df['Type']=='Exploitation']['Count'].mean()
    print(f"Average Exploration Actions per Trial: {avg_explore:.1f}")
    print(f"Average Exploitation Actions per Trial: {avg_exploit:.1f}")
    
    total_actions = avg_explore + avg_exploit
    print(f"Exploitation Rate: {(avg_exploit/total_actions)*100:.1f}%")

if __name__ == "__main__":
    analyze_static_tradeoff(FILE_PATH)